name: Pharma Daily - æ¯æ—¥åˆ¶è¯èµ„è®¯

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      date:
        description: 'æ—¥æœŸ (today/yesterday/YYYY-MM-DD)'
        required: false
        default: 'today'
      theme:
        description: 'ä¸»é¢˜ (minimal/pharma-blue/warm)'
        required: false
        default: 'minimal'

  # Push è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/daily.yml'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: pharma-daily
  cancel-in-progress: false

# æ·»åŠ å†™å…¥æƒé™
permissions:
  contents: write
  pages: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. è®¾ç½® Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      - name: Show environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Current time: $(date)"
          echo "Date input: ${{ github.event.inputs.date || 'today' }}"
          echo "Theme input: ${{ github.event.inputs.theme || 'minimal' }}"

      # 5. è¿è¡Œæ–°é—»æŠ“å–å’Œç”Ÿæˆ
      - name: Generate Pharma Daily
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL: ${{ vars.DEEPSEEK_MODEL || 'deepseek-chat' }}
        run: |
          python -m src.automation \
            --date "${{ github.event.inputs.date || 'today' }}" \
            --theme "${{ github.event.inputs.theme || 'minimal' }}" \
            --output-dir docs \
            --days-back 7

      # 6. éªŒè¯è¾“å‡º
      - name: Validate output
        run: |
          echo "Checking generated files..."
          ls -la docs/
          if [ -f docs/index.html ]; then
            echo "âœ… index.html generated successfully"
          else
            echo "âŒ index.html not found"
            exit 1
          fi

      # 7. éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          keep_files: true
          commit_message: "ğŸ“° Pharma Daily update - ${{ github.event.inputs.date || 'today' }}"

      # 8. ä¸Šä¼  Artifactsï¼ˆç”¨äºè°ƒè¯•ï¼‰
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pharma-daily-output
          path: docs/
          retention-days: 7

      # 9. å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send notification
        if: failure()
        run: |
          echo "âŒ Pharma Daily generation failed!"
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥
